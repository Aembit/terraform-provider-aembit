provider "aembit" {
}

resource "aembit_client_workload" "first_client" {
    name = "first terraform client workload"
    description = "new client workload for policy integration"
    is_active = false
    identities = [
        {
            type = "k8sNamespace"
            value = "clientworkloadNamespace"
        },
    ]
}

resource "aembit_trust_provider" "azure1" {
	name = "TF Acceptance Azure"
	azure_metadata = {
		subscription_id = "subscription_id"
	}
}

resource "aembit_integration" "wiz" {
	name = "TF Acceptance Wiz"
	type = "WizIntegrationApi"
	sync_frequency = 3600
	endpoint = "https://endpoint"
	oauth_client_credentials = {
		token_url = "https://url/token"
		client_id = "client_id"
		client_secret = "client_secret"
		audience = "audience"
	}
}

resource "aembit_access_condition" "wiz" {
	name = "TF Acceptance Wiz"
	integration_id = aembit_integration.wiz.id
	wiz_conditions = {
		max_last_seen = 3600
		container_cluster_connected = true
	}
}

resource "aembit_credential_provider" "api_key" {
	name = "TF Acceptance Policy CP"
	api_key = {
		api_key = "test"
	}
}

resource "aembit_server_workload" "first_server" {
    name = "first terraform server workload"
    description = "new server workload for policy integration"
    is_active = false
    service_endpoint = {
        host = "myhost.unittest.com"
        port = 443
        app_protocol = "HTTP"
		transport_protocol = "TCP"
        requested_port = 80
        tls_verification = "full"
	    requested_tls = true
	    tls = true
    }
}

resource "aembit_access_policy" "first_policy" {
    is_active = true
    client_workload = aembit_client_workload.first_client.id
    trust_providers = [
        aembit_trust_provider.azure1.id
    ]
    credential_provider = aembit_credential_provider.api_key.id
    server_workload = aembit_server_workload.first_server.id
}
